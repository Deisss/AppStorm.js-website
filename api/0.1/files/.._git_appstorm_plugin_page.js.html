<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
	<meta http-equiv="Content-Language" content="en" />
	<!-- Run IE in current version (not compatibility) mode -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<!-- Content information -->
	<meta name="description" content="AppStorm.JS is a framework for build fast and structured application" />
	<meta name="keywords" content="appstorm, appstorm.js, appstormjs, framework, framework-javascript, javascript, framework-js, js, appstorm-javascript" />
	<meta name="robots" content="index, follow, all" />
    <title>AppStorm.JS / API: ..\git\appstorm\plugin\page.js</title>

	<!-- FAVICON -->
	<link rel="icon" type="image/png" href="http://appstormjs.com/site/favicon.png" />
	<!--[if IE]>
		<link rel="shortcut icon" type="image/x-icon" href="http://appstormjs.com/site/favicon.ico" />
	<![endif]-->

    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
	<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="http://appstormjs.com/git/logo/ajs.png">API</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em></em>
        </div>
    </div>

    <div>
		<div class="row-fluid">
			<div id="sidebar" class="span3">
				<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Classes</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/a.html">a</a></li>
            
                <li><a href="../classes/a.ajax.html">a.ajax</a></li>
            
                <li><a href="../classes/a.callback.chainer.html">a.callback.chainer</a></li>
            
                <li><a href="../classes/a.callback.synchronizer.html">a.callback.synchronizer</a></li>
            
                <li><a href="../classes/a.console.html">a.console</a></li>
            
                <li><a href="../classes/a.environment.html">a.environment</a></li>
            
                <li><a href="../classes/a.eventEmitter.html">a.eventEmitter</a></li>
            
                <li><a href="../classes/a.form.html">a.form</a></li>
            
                <li><a href="../classes/a.keyboard.html">a.keyboard</a></li>
            
                <li><a href="../classes/a.language.html">a.language</a></li>
            
                <li><a href="../classes/a.loader.html">a.loader</a></li>
            
                <li><a href="../classes/a.message.html">a.message</a></li>
            
                <li><a href="../classes/a.page.event.html">a.page.event</a></li>
            
                <li><a href="../classes/a.page.event.hash.html">a.page.event.hash</a></li>
            
                <li><a href="../classes/a.page.template.html">a.page.template</a></li>
            
                <li><a href="../classes/a.parser.json.html">a.parser.json</a></li>
            
                <li><a href="../classes/a.parser.xml.html">a.parser.xml</a></li>
            
                <li><a href="../classes/a.state.html">a.state</a></li>
            
                <li><a href="../classes/a.state.helper.chainer.html">a.state.helper.chainer</a></li>
            
                <li><a href="../classes/a.state.helper.parameter.html">a.state.helper.parameter</a></li>
            
                <li><a href="../classes/a.state.helper.tree.html">a.state.helper.tree</a></li>
            
                <li><a href="../classes/a.state.type.html">a.state.type</a></li>
            
                <li><a href="../classes/a.storage.html">a.storage</a></li>
            
                <li><a href="../classes/a.storage.cookie.html">a.storage.cookie</a></li>
            
                <li><a href="../classes/a.storage.external.html">a.storage.external</a></li>
            
                <li><a href="../classes/a.storage.memory.html">a.storage.memory</a></li>
            
                <li><a href="../classes/a.storage.persistent.html">a.storage.persistent</a></li>
            
                <li><a href="../classes/a.storage.temporary.html">a.storage.temporary</a></li>
            
                <li><a href="../classes/a.storage.type.cookie.html">a.storage.type.cookie</a></li>
            
                <li><a href="../classes/a.storage.type.flash.html">a.storage.type.flash</a></li>
            
                <li><a href="../classes/a.storage.type.globalStorage.html">a.storage.type.globalStorage</a></li>
            
                <li><a href="../classes/a.storage.type.javafx.html">a.storage.type.javafx</a></li>
            
                <li><a href="../classes/a.storage.type.localStorage.html">a.storage.type.localStorage</a></li>
            
                <li><a href="../classes/a.storage.type.memory.html">a.storage.type.memory</a></li>
            
                <li><a href="../classes/a.storage.type.sessionStorage.html">a.storage.type.sessionStorage</a></li>
            
                <li><a href="../classes/a.storage.type.silverlight.html">a.storage.type.silverlight</a></li>
            
                <li><a href="../classes/a.storage.type.userData.html">a.storage.type.userData</a></li>
            
                <li><a href="../classes/a.timer.html">a.timer</a></li>
            
        </ul>
    </div>
</div>










<div id="fileTree" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Files</h2>
    </div>
    <div class="bd">
        <ul><li>..\git\appstorm\a.js/<ul></ul></li><li>..\git\appstorm\plugin\callback.js/<ul></ul></li><li>..\git\appstorm\plugin\form.js/<ul></ul></li><li>..\git\appstorm\plugin\keyboard.js/<ul></ul></li><li>..\git\appstorm\plugin\language.js/<ul></ul></li><li>..\git\appstorm\plugin\page.js/<ul></ul></li><li>..\git\appstorm\plugin\state.js/<ul></ul></li><li>..\git\appstorm\plugin\storage.js/<ul></ul></li></ul>
    </div>
</div>



			</div>
			<div id="main" class="span9">
				<div class="content"><h4>..\git\appstorm\plugin\page.js</h4>

<pre class="code prettyprint linenums">
&quot;use strict&quot;;
/* ************************************************************************

	Version: 0.3

	License: MIT Licence

	Authors: VILLETTE Charles

	Date: 2013-05-14

	Date of last modification: 2013-07-12

	Dependencies : [
		a.js
		plugin/callback.js
		plugin/language.js (optional)

		** Mustache.js OR handlebars.js IS NEEDED AND IS EXTERNAL LIBRARY **
	]

	Events : [
		event {
			a.page.event.resize    : {}
			a.page.event.load      : {}
			a.page.event.unload    : {}
			a.page.event.hibernate : {}
			a.page.event.hash      : {value : current value, old : previous value}
		}
	]

	Description:
		Manipulate the page event, history. We define here some usefull function to catch some important event (page lifetime)

		template : Create a simple but powerfull template system
		event : Catch here basic windows event : onload, onunload, onresize, onhibernate, onhash

************************************************************************ */

// Provide basic page event/template management structure
a.page = {};




/**
 * Create a simple but powerfull template system
 *
 * Examples: &lt;a href=&quot;http://appstormjs.com/wiki/doku.php?id=appstorm.js_v0.1:plugins:page&quot;&gt;here&lt;/a&gt;
 *
 * @class template
 * @static
 * @namespace a.page
*/
a.page.template = {
	/**
	 * Store cached template
	 * @property __tmpl
	 * @type Object
	 * @default {}
	*/
	__tmpl : {},

	/**
	 * Use cache or retrieve a specific template from network
	 *
	 * @method get
	 * @async
	 *
	 * @param uri {String} The path to get the template, or an id if the template already listed in html
	 * @param data {Object} The data to apply to template
	 * @param callback {Function} The callback to apply when template finish loading
	 * @param error {Function | null} The error to raise in case of problem
	*/
	get : function(uri, data, callback, error) {
		var handler = null;

		// If mustache is not define (Mustache is not defined) we exit
		if(a.isObject(window.Mustache)) {
			handler = window.Mustache;
		} else if(a.isObject(window.Handlebars)) {
			handler = window.Handlebars;
		}

		// Crash if none is found
		if(handler == null) {
			a.console.error(&quot;a.page.template.get: unable to find Mustache.JS or Handlebars.JS ! Can&#x27;t proceed&quot;, 1);
			return;
		}

		// We create a hash from uri and sanitize everything by replacing by underscore
		var orig = uri.replace(/[^a-zA-Z0-9\\-]/g, &quot;_&quot;),
			hash = &quot;a_tmpl_&quot; + orig + &quot;_a&quot;;

		/**
		 * Parse the content with data from client, then call callback with result
		 *
		 * @method callCallback
		 * @private
		 * @async
		 *
		 * @param clb {Function} The callback function to call
		 * @param h {String} The hash representing the unique id of template
		 * @param d {Object} The data associated
		*/
		var callCallback = function(clb, h, d) {
			if(a.isFunction(clb)) {

				// First try to use Handlebars.js
				if(a.isNull(handler.to_html)) {
					// Act like a render method (threw compile method)
					var tmpl = handler.compile(a.page.template.__tmpl[h]);
					clb(tmpl(d));

				// Rollback on Mustache.js
				} else {
					clb(handler.to_html(a.page.template.__tmpl[h], d));
				}
			}
		};

		// If the template is already listed into existing template, directly load
		if(a.isString(this.__tmpl[hash])) {
			a.console.log(&quot;a.page.template.get: loading &quot; + hash + &quot; from cache&quot;, 3);
			callCallback(callback, hash, data);
			return;
		}

		// Template exist on page DOM, but it&#x27;s not registred to ich for now
		if(document.getElementById(hash)) {
			// We add it to template list registered to go quicker next time
			if(!this.__tmpl[hash]) {
				a.console.log(&quot;a.page.template.get: loading &quot; + hash + &quot; from inner html page&quot;, 3);
				this.__tmpl[hash] = document.getElementById(hash).innerHTML;
			}

			// We finally send the callback
			callCallback(callback, hash, data);
			return;
		}

		// Same with this time original id, template exist on page DOM
		if(document.getElementById(orig)) {
			// We add it to template list registered to go quicker next time
			if(!this.__tmpl[orig]) {
				a.console.log(&quot;a.page.template.get: loading &quot; + orig + &quot; from inner html page&quot;, 3);
				this.__tmpl[orig] = document.getElementById(orig).innerHTML;
			}

			// We finally send the callback
			callCallback(callback, orig, data);
			return;
		}

		// Last try : we try to use uri to load template from server side, then parse it
		var parse = function(content, status, state) {
			if(!a.page.template.__tmpl[hash]) {
				a.page.template.__tmpl[hash] = content;
			}
			callCallback(callback, hash, data);
			return;
		};

		// We use the loader to retrieve file from server side
		a.console.log(&quot;a.page.template.get: loading &quot; + uri + &quot; from external resource&quot;, 3);
		a.loader.html(uri, parse, {}, error);
	},

	/**
	 * Convert an html to a dom content
	 *
	 * @method htmlToDom
	 *
	 * @param html {String} The string to parse
	 * @return {Array} The result content
	*/
	htmlToDom : function(html) {
		/*
		 * Why this ?
		 * - Using innerHTML is slow, and can remove binding (like onclick) to sibling children
		 * - Doing this way is the only way to have both: full parsing on every browser, and DOM element to not have innerHTML bug.
		 *      as innerHTML is configured into a temp object, this problem does not exist here anymore as it will not affect other children...
		*/
		var d = document.createElement(&quot;div&quot;);
		// Remove space before and after : the system fail in other case (why ?)
		d.innerHTML  = html.replace(/^\s+|\s+$/g, &quot;&quot;);
		var nodeList = d.childNodes,
			result   = [];
		for(var i=0, l=nodeList.length; i&lt;l; ++i) {
			var item = nodeList.item(i);
			if(a.isObject(item) &amp;&amp; (item.nodeType.toString() === &quot;1&quot; || item.nodeType.toString() === &quot;3&quot;)) {
				result.push(item);
			}
		}
		return result;
	},

	/**
	 * Empty a dom element
	 *
	 * @method remove
	 * @async
	 *
	 * @param el {DOMElement} The element to remove everything inside
	 * @param callback {Function | null} The function to raise when job is done
	*/
	remove : function(el, callback) {
		while(el.firstChild) {
			el.removeChild(el.firstChild);
		}
		if(a.isFunction(callback)) {
			callback();
		}
	},

	/**
	 * Append to the given element (given a DOM element here not a jquery one)
	 *
	 * @method append
	 * @async
	 *
	 * @param el {DOMElement} Any dom element to append to
	 * @param content {String} The html content (in string) to replace
	 * @param callback {Function} The callback to apply when template finish loading
	*/
	append : function(el, content, callback) {
		var h = this.htmlToDom(content);
		if(a.isObject(h)) {
			for(var i=0, l=h.length; i&lt;l; ++i) {
				el.appendChild(h[i]);
			}
		}
		if(!a.isNull(a.language)) {
			a.language.translate(el);
		}
		if(a.isFunction(callback)) {
			callback(content);
		}
	},

	/**
	 * Same as append, just replace instead of append to element
	 *
	 * @method replace
	 * @async
	 *
	 * @param el {DOMElement} Any dom element to append to
	 * @param content {String} The html content (in string) to replace
	 * @param callback {Function} The callback to apply when template finish loading
	*/
	replace : function(el, content, callback) {
		this.remove(el);
		this.append(el, content, callback);
	}
};





/**
 * Catch here basic windows event : onload, onunload, onresize, onhibernate, onhash
 * onHibernate is a custom event when system seems to come back from hibernate mode
 * onHash is a custom event when page hash change
 *
 * Examples: &lt;a href=&quot;http://appstormjs.com/wiki/doku.php?id=appstorm.js_v0.1:plugins:page&quot;&gt;here&lt;/a&gt;
 *
 * @class event
 * @static
 * @namespace a.page
 *
 * @event a.page.event.hibernate when page have a too large waiting elapse time between two timer tick
*/
a.page.event = (function() {
	&quot;use strict&quot;;

	/*
	---------------------------------
	  HIBERNATE EVENT
	---------------------------------
	*/

	// Patching himself with new elements
	var obj = {};

	// We create a new event hibernate : when the system go into a hibernate state, when going back, the system raise this event
	// This can be pretty helpfull on real time system saying &quot;hey you should reload stuff you may have a data lost&quot;
	var __hibernateDelay = 10000,
		__last = (new Date()).getTime();

	/**
	 * Create the callback from the given event name
	 *
	 * @method __getPageEventCallback
	 * @private
	 *
	 * @param event {String} The event name
	 * @param data {Object | null} The data attached to event
	 * @return {Function} A ready to use callback
	*/
	function __getPageEventCallback(event, data) {
		if(!a.isObject(data)) {
			data = {};
		}
		return function() {
			a.message.dispatch(&quot;a.page.event.&quot; + event, data);
		};
	};

	/**
	 * Check the system is hibernating or not
	 *
	 * @method __checkHibernate
	 * @private
	*/
	function __checkHibernate() {
		var current = (new Date()).getTime();
		if(current &gt; (__last + __hibernateDelay * 2)) {
			//The system probably woke up, we send an event for that
			a.console.log(&quot;a.page.event.hibernate: hibernate mode has been detected&quot;, 3);
			var fct = __getPageEventCallback(&quot;hibernate&quot;);
			fct();
		}
		__last = current;
	};

	/**
	 * Attach a callback to a DOM event
	 *
	 * @method __attachDOMEvent
	 * @private
	 * @async
	 *
	 * @param event {String} The event name
	 * @param callback {Function} The callback to attach
	*/
	function __attachDOMEvent(event, callback) {
		if(window.addEventListener) { // W3C
			window.addEventListener(event, callback, false);
		} else if(window.attachEvent) { // Microsoft
			window.attachEvent(&quot;on&quot; + event, callback);
		}
	};




	/*
	---------------------------------
	  HASH EVENT
	---------------------------------
	*/
	var __previousHash = null,
		__registredHash = [];

	/**
	 * Retrieve the current system hash
	 *
	 * @method __getHash
	 * @private
	 *
	 * @return {String | null} The hash, or null if nothing is set
	 */
	function __getHash() {
		return (window.location.hash) ? window.location.hash.substring(1) : null;
	};


	/**
	 * Store the latest event appearing into a store
	 *
	 * @method __addHash
	 * @private
	 *
	  @param hash {String} The new hash incoming
	*/
	function __addHash(hash) {
		// Store both hash and time used
		__registredHash.push({
			hash : hash,
			time : (new Date()).getTime()
		});

		// Remove exceed hash stored
		while(__registredHash.length &gt; 1000) {
			__registredHash.shift();
		}
	};

	/**
	 * Check for existing hash, call the callback if there is any change
	 *
	 * @method __checkHash
	 * @private
	 *
	 * @param noCallback {Boolean} Indicate if the system should call the callback or not
	 */
	function __checkHash(noCallback) {
		//Extracting hash, or null if there is nothing to extract
		var currentHash = __getHash();
		if(__previousHash !== currentHash) {
			if(noCallback !== true) {
				__addHash(currentHash);
				// Dispatch event
				a.console.log(&quot;a.page.event.hash: hash change (previous: &quot; + __previousHash + &quot;, new: &quot; + currentHash + &quot;)&quot;, 3);
				var fct = __getPageEventCallback(&quot;hash&quot;, {
					value : currentHash,
					old : __previousHash
				});
				fct();
			}
			__previousHash = currentHash;
		}
	};

	// Get hash data threw this specific object type
	// see : http://simplapi.wordpress.com/2012/08/20/checking-an-url-hash-change-in-javascript/
	/**
	 * Manipulate page hash
	 *
	 * Examples: &lt;a href=&quot;http://appstormjs.com/wiki/doku.php?id=appstorm.js_v0.1:plugins:page&quot;&gt;here&lt;/a&gt;
	 *
	 * @class hash
	 * @static
	 * @namespace a.page.event
	*/
	obj.hash = {
		/**
		 * Retrieve the current system hash
		 *
		 * @method getHash
		 *
		 * @return {String | null} The hash, or null if nothing is set
		 */
		getHash : function() {
			return __getHash();
		},

		/**
		 * Get the previous page hash (can be null)
		 *
		 * @method getPreviousHash
		 *
		 * @return {String | null} The hash, or null if nothing is set
		*/
		getPreviousHash : function() {
			return __previousHash;
		},

		/**
		 * Force the system to set a specific hash
		 *
		 * @method setPreviousHash
		 *
		 * @param value {String} The hash to set
		 */
		setPreviousHash : function(value) {
			a.console.log(&quot;a.page.event.hash.setPreviousHash: change previous hash to &quot; + value, 3);
			__previousHash = value;
		},

		/**
		 * Get list of existing previous hash used into system
		 *
		 * @method trace
		 *
		 * @return {Array} An array with all hash done since beginning
		*/
		trace : function() {
			return __registredHash;
		}
	};

	//Initiate the system
	__checkHash(true);

	//The onhashchange exist in IE8 in compatibility mode, but does not work because it is disabled like IE7
	if(!a.isNull(window.onhashchange) &amp;&amp; (document.documentMode === undefined || document.documentMode &gt; 7)) {
		//Many browser support the onhashchange event, but not all of them
		window.onhashchange = __checkHash;
	} else {
		//Starting manual function check, if there is no event to attach
		a.timer.add(__checkHash, null, 50);
	}

	


	/*
	---------------------------------
	  DOM LOAD/UNLOAD EVENT
	---------------------------------
	*/

	// Now on event, raise the object behaviour
	var eventList = [&quot;resize&quot;, &quot;load&quot;, &quot;unload&quot;];
	for(var i in eventList) {
		__attachDOMEvent(eventList[i], __getPageEventCallback(eventList[i]));
	}

	// Bind the hibernate starter with onload event, 
	// because before the system may not respond on time, indicating an hibernate event to timer
	// Which is not true.
	__attachDOMEvent(&quot;load&quot;, function() {
		// We start hibernate system
		a.timer.add(__checkHibernate, null, __hibernateDelay);
	});

	return obj;
}());

</pre>

</div>
			</div>
		</div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>

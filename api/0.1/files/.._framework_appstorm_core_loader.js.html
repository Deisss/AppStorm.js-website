<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
	<meta http-equiv="Content-Language" content="en" />
	<!-- Run IE in current version (not compatibility) mode -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<!-- Content information -->
	<meta name="description" content="AppStorm.JS is a framework for build fast and structured application" />
	<meta name="keywords" content="appstorm, appstorm.js, appstormjs, framework, framework-javascript, javascript, framework-js, js, appstorm-javascript" />
	<meta name="robots" content="index, follow, all" />
    <title>AppStorm.JS / API: ..\framework\appstorm\core\loader.js</title>

	<!-- FAVICON -->
	<link rel="icon" type="image/png" href="http://appstormjs.com/site/favicon.png" />
	<!--[if IE]>
		<link rel="shortcut icon" type="image/x-icon" href="http://appstormjs.com/site/favicon.ico" />
	<![endif]-->

    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
	<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="http://appstormjs.com/framework/logo/ajs.png">API</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em></em>
        </div>
    </div>

    <div>
		<div class="row-fluid">
			<div id="sidebar" class="span3">
				<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Classes</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/a.html">a</a></li>
            
                <li><a href="../classes/a.ajax.html">a.ajax</a></li>
            
                <li><a href="../classes/a.callback.chainer.html">a.callback.chainer</a></li>
            
                <li><a href="../classes/a.callback.synchronizer.html">a.callback.synchronizer</a></li>
            
                <li><a href="../classes/a.console.html">a.console</a></li>
            
                <li><a href="../classes/a.environment.html">a.environment</a></li>
            
                <li><a href="../classes/a.eventEmitter.html">a.eventEmitter</a></li>
            
                <li><a href="../classes/a.form.html">a.form</a></li>
            
                <li><a href="../classes/a.keyboard.html">a.keyboard</a></li>
            
                <li><a href="../classes/a.language.html">a.language</a></li>
            
                <li><a href="../classes/a.loader.html">a.loader</a></li>
            
                <li><a href="../classes/a.message.html">a.message</a></li>
            
                <li><a href="../classes/a.page.event.html">a.page.event</a></li>
            
                <li><a href="../classes/a.page.event.hash.html">a.page.event.hash</a></li>
            
                <li><a href="../classes/a.page.template.html">a.page.template</a></li>
            
                <li><a href="../classes/a.parser.json.html">a.parser.json</a></li>
            
                <li><a href="../classes/a.parser.xml.html">a.parser.xml</a></li>
            
                <li><a href="../classes/a.state.html">a.state</a></li>
            
                <li><a href="../classes/a.state.helper.chainer.html">a.state.helper.chainer</a></li>
            
                <li><a href="../classes/a.state.helper.parameter.html">a.state.helper.parameter</a></li>
            
                <li><a href="../classes/a.state.helper.tree.html">a.state.helper.tree</a></li>
            
                <li><a href="../classes/a.state.type.html">a.state.type</a></li>
            
                <li><a href="../classes/a.storage.html">a.storage</a></li>
            
                <li><a href="../classes/a.storage.cookie.html">a.storage.cookie</a></li>
            
                <li><a href="../classes/a.storage.external.html">a.storage.external</a></li>
            
                <li><a href="../classes/a.storage.memory.html">a.storage.memory</a></li>
            
                <li><a href="../classes/a.storage.persistent.html">a.storage.persistent</a></li>
            
                <li><a href="../classes/a.storage.temporary.html">a.storage.temporary</a></li>
            
                <li><a href="../classes/a.storage.type.cookie.html">a.storage.type.cookie</a></li>
            
                <li><a href="../classes/a.storage.type.flash.html">a.storage.type.flash</a></li>
            
                <li><a href="../classes/a.storage.type.globalStorage.html">a.storage.type.globalStorage</a></li>
            
                <li><a href="../classes/a.storage.type.javafx.html">a.storage.type.javafx</a></li>
            
                <li><a href="../classes/a.storage.type.localStorage.html">a.storage.type.localStorage</a></li>
            
                <li><a href="../classes/a.storage.type.memory.html">a.storage.type.memory</a></li>
            
                <li><a href="../classes/a.storage.type.sessionStorage.html">a.storage.type.sessionStorage</a></li>
            
                <li><a href="../classes/a.storage.type.silverlight.html">a.storage.type.silverlight</a></li>
            
                <li><a href="../classes/a.storage.type.userData.html">a.storage.type.userData</a></li>
            
                <li><a href="../classes/a.timer.html">a.timer</a></li>
            
        </ul>
    </div>
</div>










<div id="fileTree" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Files</h2>
    </div>
    <div class="bd">
        <ul><li>..\framework\appstorm\a.js/<ul></ul></li><li>..\framework\appstorm\core\ajax.js/<ul></ul></li><li>..\framework\appstorm\core\console.js/<ul></ul></li><li>..\framework\appstorm\core\environment.js/<ul></ul></li><li>..\framework\appstorm\core\loader.js/<ul></ul></li><li>..\framework\appstorm\core\message.js/<ul></ul></li><li>..\framework\appstorm\core\parser.js/<ul></ul></li><li>..\framework\appstorm\core\timer.js/<ul></ul></li><li>..\framework\appstorm\plugin\callback.js/<ul></ul></li><li>..\framework\appstorm\plugin\form.js/<ul></ul></li><li>..\framework\appstorm\plugin\keyboard.js/<ul></ul></li><li>..\framework\appstorm\plugin\language.js/<ul></ul></li><li>..\framework\appstorm\plugin\page.js/<ul></ul></li><li>..\framework\appstorm\plugin\state.js/<ul></ul></li><li>..\framework\appstorm\plugin\storage.js/<ul></ul></li></ul>
    </div>
</div>



			</div>
			<div id="main" class="span9">
				<div class="content"><h4>..\framework\appstorm\core\loader.js</h4>

<pre class="code prettyprint linenums">
/* ************************************************************************

	License: MIT Licence

	Authors: VILLETTE Charles

	Date: 2013-05-11

	Date of last modification: 2013-10-11

	Dependencies : [
		a.js
	]

	Events : []

	Description:
		Dynamic loader for many files type

************************************************************************ */


/**
 * Dynamic loader for many files type
 *
 * Examples: &lt;a href=&quot;http://appstormjs.com/wiki/doku.php?id=appstorm.js_v0.1:core:loader&quot;&gt;here&lt;/a&gt;
 *
 * @class loader
 * @static
 * @namespace a
*/
a.loader = (function() {
	&quot;use strict&quot;;

	// Store some cache here
	var __cache = [],
		// Store the number of css files currently loading threw timer hack...
		nCSS = 0,
		nJS  = 0,
		htmlMethods = [&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;];

	/**
	 * Check the cache, and launch callback if uri is already listed in cache
	 *
	 * @method __checkCache
	 * @private
	 * @async
	 *
	 * @param uri {String} The path to access data
	 * @param callback {Function | null} The callback to apply after loader
	 * @return {Boolean} True if it&#x27;s already inside cache, and false in other case
	*/
	function __checkCache(uri, callback) {
		// Search in cache
		if(a.isNull(uri)) {
			return false;
		}

		for(var i=0, l=__cache.length; i&lt;l; ++i) {
			if(__cache[i] === uri) {
				// This exist in cache, we directly call callback
				if(a.isFunction(callback)) {
					callback();
				}
				return true;
			}
		}

		return false;
	};

	/**
	 * Insert into cache if needed the uri
	 *
	 * @method __populateCache
	 * @private
	 *
	 * @param uri {String} The path to access data
	 * @param args {Object} The arguments to check if cache is specified and policy to use
	*/
	function __populateCache(uri, args) {
		// By default, we cache
		if(!a.isNull(args) &amp;&amp; args.cache === false) {
			return;
		}
		__cache.push(uri);
	};

	/**
	 * Append to header the given tag, used by JS and CSS loader especially
	 *
	 * @method __appendToHeader
	 * @private
	 * @async
	 *
	 * @param el {DOM} A createElement type result
	 * @param options {Object} HTML Options to add to link appended
	 * @param callback {Function | null} The callback to apply after loader
	 * @param uri {String} The path to access data
	 * @param args {Object | null} The arguments to check if cache is specified and policy to use
	 * @param error {Function | null} The callback to raise in case of problem (never used)
	*/
	function __appendToHeader(el, options, callback, uri, args, error) {
		for(var i in options) {
			el.setAttribute(i, options[i]);
		}

		if(!a.isNull(args) &amp;&amp; args.id) {
			el.setAttribute(&quot;id&quot;, args.id);
		}

		// Handle if system already trigger or not callback

		var trigger = false;
		// The common callback for both onload and readystatechange
		var cb = function(e) {
			if(trigger) {
				return;
			}

			trigger = true;
			if(a.isFunction(callback)) {
				callback(el);
			}
			__populateCache(uri, args);
		};

		if(el.addEventListener) {
			el.addEventListener(&quot;load&quot;, cb, false);
		} else if(el.readyState) {
			el.onreadystatechange = function() {
				if (this.readyState === &quot;complete&quot; || this.readyState === &quot;loaded&quot;) {
					cb();
				}
			};
		} else {
			el.onload = cb;
		}

		// Hack for old Firefox/webkit browsers (who does not have onload on link elements)
		// Note : using &#x27;onload&#x27; in document.createElement(&#x27;link&#x27;) is not always enough
		// By default, too many browser got this bug, so we always activate it
		if(options.type === &quot;text/css&quot;) {
			var currentCSS = document.styleSheets.length;
			nCSS++;
			var cssLoad = a.timer.add(
				function() {
					if (document.styleSheets.length &gt; (currentCSS + nCSS - 1)) {
						nCSS--;
						a.timer.remove(cssLoad);
						cb();
					}   
				}
			, null, 50);
		}

		// Inserting document into header
		document.getElementsByTagName(&quot;head&quot;)[0].appendChild(el);
	};

	/**
	 * load some data threw AJAX
	 *
	 * @method __ajaxLoader
	 * @private
	 * @async
	 *
	 * @param uri {String} The data path
	 * @param callback {Function | null} The callback to apply in case of success
	 * @param args {Object | null} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
	 * @param error {Function | null} The callback to apply in case of error
	*/
	function __ajaxLoader(uri, callback, args, error) {
		var options = {
			url    : uri,   //Allowed type : any URL
			method : &quot;GET&quot;, //Allowed type : &quot;GET&quot;, &quot;POST&quot;
			type   : &quot;raw&quot;, //Allowed type : raw, json, xml
			async  : true,  //Allowed type : true, false
			cache  : true,  //Allowed type : true, false
			data   : {},    //Allowed type : any kind of object composed of key =&gt; value
			header : {}     //Allowed type : any kind of object composed of key =&gt; value
		};

		a.console.log(&quot;a.loader: load resource (url: &quot; + uri + &quot;)&quot;, 3);
		if(!a.isNull(args)) {
			if(a.contains(htmlMethods, args.method) ) {
				options.method = args.method;
			}
			if(!a.isNull(args.type) &amp;&amp; (args.type === &quot;json&quot; || args.type === &quot;xml&quot;) ) {
				options.type = args.type;
			}
			if(a.isObject(args.data)) {
				options.data = args.data;
			}
			if(a.isObject(args.header)) {
				options.header = args.header;
			}
			if(a.isBoolean(args.cache)) {
				options.cache = args.cache;
			}
		}

		// The real callback handling response
		var handlerCallback = function(content, status) {
			if(a.isFunction(callback)) {
				callback(content, status);
			}
			__populateCache(uri, args);
		};

		// Loading data
		var er = (a.isFunction(error)) ? error : function(){};
		(new a.ajax(options, handlerCallback, er)).send();
	};

	return {
		/**
		 * Javascript loader
		 *
		 * @method js
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		js : function(uri, callback, args, error) {
			if(__checkCache(uri, callback)) {
				return;
			}

			this.jsonp(uri, callback, args, error);
		},

		/**
		 * JSONP loader
		 *
		 * @method jsonp
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		jsonp : function(uri, callback, args, error){
			var type = (a.isObject(args) &amp;&amp; args.type) ? args.type : &quot;text/javascript&quot;;
			a.console.log(&quot;a.loader: load resource (url: &quot; + uri + &quot;)&quot;, 3);
			__appendToHeader(document.createElement(&quot;script&quot;), {
					type : type,
					src : uri
				}, callback, uri, args, error
			);
		},

		/**
		 * JSON loader
		 *
		 * @method json
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		json : function(uri, callback, args, error) {
			// Setting type
			if(!a.isObject(args)) {
				args = {};
			}
			args.type = &quot;json&quot;;

			// Setting the accepted return type
			if(!a.isObject(args.header)) {
				args.header = {};
			}
			args.header[&quot;accept&quot;] = &quot;application/json, text/javascript&quot;;

			__ajaxLoader(uri, callback, args, error);
		},

		/**
		 * XML loader
		 *
		 * @method xml
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		xml : function(uri, callback, args, error) {
			// Setting the type
			if(!a.isObject(args)) {
				args = {};
			}
			args.type = &quot;xml&quot;;

			// Setting the accepted return type
			if(!a.isObject(args.header)) {
				args.header = {};
			}
			args.header[&quot;accept&quot;] = &quot;application/xml, text/xml&quot;;

			__ajaxLoader(uri, callback, args, error);
		},

		/**
		 * CSS loader
		 *
		 * @method css
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		css : function(uri, callback, args, error) {
			if(__checkCache(uri, callback)) {
				return;
			}

			a.console.log(&quot;a.loader: load resource (url: &quot; + uri + &quot;)&quot;, 3);
			__appendToHeader(document.createElement(&quot;link&quot;), {
					rel  : &quot;stylesheet&quot;,
					type : &quot;text/css&quot;,
					href : uri
				}, callback, uri, args, error
			);
		},

		/**
		 * HTML loader
		 * NOTE : only valid XHTML is accepted !
		 *
		 * @method html
		 * @async
		 *
		 * @param uri {String} The path to access content
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An ajax argument object, not all of them are used (some are automatically generated and cannot be changed)
		*/
		html : function(uri, callback, args, error) {
			if(__checkCache(uri, callback)) {
				return;
			}

			// Setting type
			if(!a.isObject(args)) {
				args = {};
			}
			args.type = &quot;raw&quot;;

			// In debug mode, we disallow cache
			if(a.environment.get(&quot;debug&quot;) === true) {
				args.cache = false;
			}

			// Setting the accepted return type
			if(!a.isObject(args.header)) {
				args.header = {};
			}
			args.header[&quot;accept&quot;] = &quot;text/html&quot;;
			__ajaxLoader(uri, callback, args, error);
		},

		/**
		 * JavaFX loader
		 *
		 * @method javafx
		 * @async
		 *
		 * @param uri {String} The path for given jar files to load
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An object to set property for javaFX (like javascript name...), we need : args.code (the main to start), args.id (the id of project). args.width and height are optional
		*/
		javafx : function(uri, callback, args, error) {
			if(a.isNull(args) || a.isNull(args.code) || a.isNull(args.id)) {
				a.console.warn(&quot;a.loader.javafx : the system need args.code and args.name setted to be able to load any javafx resource... This uri will not be loaded : &quot; + uri, 3);
				return;
			}

			if(__checkCache(uri, callback)) {
				return;
			}

			// Load (if needed) javaFX javascript include helper
			var version = (args.version) ? args.version : &quot;1.3&quot;;
			this.js(&quot;http://dl.javafx.com/&quot; + version + &quot;/dtfx.js&quot;, function() {
				javafx({
					archive: uri,
					width: args.width || 1,
					height: args.height || 1,
					code: args.code,
					name: args.id
				});
			});

			// There is no &quot;load&quot; event, so we emulate one
			var timer = null,
				max = 2000;

			timer = a.timer.add(function() {
				// Valid when max &lt;ait occurs or system is loaded
				if(max-- &gt; 0 &amp;&amp; !a.isNull(document.getElementById(args.id).Packages)) {
					a.timer.remove(timer);
					if(a.isFunction(callback)) {
						callback();
					}
				} else if(max &lt;= 0 &amp;&amp; a.isFunction(error)) {
					error(uri, 408);
				}
			}, null, 200);
		},

		/**
		 * Flash loader
		 *
		 * @method flash
		 * @async
		 *
		 * @param uri {String} The path for given swf files to load
		 * @param callback {Function | null} The callback to call after loading success
		 * @param args {Object} An object to set property for Flash
		*/
		flash : function(uri, callback, args, error) {
			if(a.isNull(args) || a.isNull(args.rootId) || a.isNull(args.id)) {
				a.console.warn(&quot;a.loader.flash : the system need args parameters : rootId, id, setted to be able to load any flash resource... This uri will not be loaded : &quot; + uri, 3);
				return;
			}

			if(__checkCache(uri, callback)) {
				return;
			}

			// Load (if needed) the swfobject.js to load flash from that
			this.js(a.url + &quot;vendor/storage/flash/swfobject.js&quot;, function() {
				swfobject.embedSWF(uri, args.rootId, &quot;100%&quot;, &quot;100%&quot;, &quot;10.0.0&quot;, a.url + &quot;vendor/storage/flash/expressInstall.swf&quot;, args.flashvars, args.params, {id : args.id}, function(e) {
					// We do make a small timeout, for a strange reason the success event is not really ready
					if(e.success === false &amp;&amp; a.isFunction(error)) {
						error(uri, 408);
					}else if(e.success === true &amp;&amp; a.isFunction(callback)) {
						setTimeout(callback, 500);
					}
				});
			});
		},

		/**
		 * Silverlight loader
		 *
		 * @method silverlight
		 * @async
		 *
		 * @param uri {String} The path for given xap files to load
		 * @param callback {Function | null} The callback to call after loading success (NOTE : silverlight is not able to fire load event, so it&#x27;s not true here...)
		 * @param args {Object} An object to set property for Silverlight
		*/
		silverlight : function(uri, callback, args, error) {
			if(a.isNull(args) || a.isNull(args.rootId) || a.isNull(args.id)) {
				a.console.warn(&quot;a.loader.silverlight : the system need args parameters : rootId, id, setted to be able to load any silverlight resource... This uri will not be loaded : &quot; + uri, 3);
				return;
			}

			if(__checkCache(uri, callback)) {
				return;
			}

			a.console.log(&quot;a.loader: load resource (url: &quot; + uri + &quot;)&quot;, 3);
			var obj = document.createElement(&quot;object&quot;);
			obj.id = args.id;
			obj.data = &quot;data:application/x-silverlight-2,&quot;
			obj.type = &quot;application/x-silverlight-2&quot;;

			if(!a.isArray(args.params)) {args.params = [];}

			// Adding URI to element
			args.params.push({name : &quot;source&quot;, value : uri});

			for(var i=0, l=args.params.length; i&lt;l; ++i) {
				var param = document.createElement(&quot;param&quot;);
				param.name = args.params[i].name;
				param.value = args.params[i].value;
				obj.appendChild(param);
			}

			document.getElementById(args.rootId).appendChild(obj);

			// There is no &quot;load&quot; event, so we emulate one
			var timer = null,
				max = 2000;

			timer = a.timer.add(function() {
				// Valid when max &lt;ait occurs or system is loaded
				if(max-- &gt; 0 &amp;&amp; !a.isNull(document.getElementById(args.id).Content)) {
					a.timer.remove(timer);
					callback();
				} else if(max &lt;= 0 &amp;&amp; a.isFunction(error)) {
					error(uri, 408);
				}
			}, null, 200);
		},

		/**
		 * Get the cache trace loaded
		 *
		 * @method trace
		 *
		 * @return {Array} The cache trace
		*/
		trace : function() {
			return __cache;
		}
	};
}());
</pre>

</div>
			</div>
		</div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
